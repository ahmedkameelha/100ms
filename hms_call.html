<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>100ms Video Call</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #111;
      color: white;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    #status-container {
      position: absolute;
      top: 0; left: 0; right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      z-index: 10;
      transition: opacity 0.3s ease;
    }

    #top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #1a1a1a;
      padding: 8px 16px;
      font-size: 0.9rem;
      border-bottom: 1px solid #333;
    }

    #video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      grid-gap: 10px;
      padding: 10px;
      flex: 1;
      overflow-y: auto;
    }

    .video-tile {
      position: relative;
      background: #222;
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .video-tile video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }

    .avatar-placeholder {
      font-size: 2rem;
      background: #444;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tile-overlay {
      position: absolute;
      bottom: 5px;
      left: 5px;
      right: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(0, 0, 0, 0.5);
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .mute-icon i {
      color: red;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      background: #1a1a1a;
      padding: 10px;
    }

    .controls button {
      background: #333;
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.3s;
    }

    .controls button:hover {
      background: #555;
    }

    .controls button.toggled-off {
      background: #a33;
    }
  </style>
</head>
<body>
  <div id="status-container"><span id="status">Connecting...</span></div>

  <div id="top-bar">
    <div id="user-info">Guest | <span id="call-timer">00:00</span></div>
    <div><i class="fa-solid fa-users"></i> <span id="participant-count">0</span></div>
  </div>

  <div id="video-grid"></div>

  <div class="controls">
    <button id="mic-btn"><i class="fa-solid fa-microphone"></i></button>
    <button id="cam-btn"><i class="fa-solid fa-video"></i></button>
    <button id="end-call-btn"><i class="fa-solid fa-phone-slash"></i></button>
  </div>

  <script src="https://unpkg.com/@100mslive/hms-video-store@latest/dist/hms-video-store.umd.js"></script>
  <script>
    let hmsManager, hmsStore, hmsActions;
    let callStartTime = null;
    let callTimerInterval = null;

    const {
      selectPeers,
      selectIsLocalAudioEnabled,
      selectIsLocalVideoEnabled,
      selectIsConnectedToRoom,
    } = window.HMSReactiveStore;

    const statusContainer = document.getElementById("status-container");
    const statusEl = document.getElementById("status");
    const videoGrid = document.getElementById("video-grid");
    const participantCountEl = document.getElementById("participant-count");
    const callTimerEl = document.getElementById("call-timer");

    async function initHMS() {
      try {
        const params = new URLSearchParams(window.location.search);
        const roomId = params.get("roomId");
        const userName = params.get("userName") || "Guest";
        if (!roomId) throw new Error("Room ID is missing from URL!");

        document.getElementById("user-info").childNodes[0].textContent = `${userName} | `;

        hmsManager = new window.HMSReactiveStore();
        hmsManager.triggerOnSubscribe();
        hmsStore = hmsManager.getStore();
        hmsActions = hmsManager.getHMSActions();

        const authToken = await hmsActions.getAuthTokenByRoomCode({
          roomCode: roomId,
        });

        await hmsActions.join({
          userName,
          authToken,
          settings: { isAudioMuted: false, isVideoMuted: false },
        });

        hmsStore.subscribe(onConnectionUpdate, selectIsConnectedToRoom);
        hmsStore.subscribe(renderPeers, selectPeers);
        hmsStore.subscribe(updateMicButton, selectIsLocalAudioEnabled);
        hmsStore.subscribe(updateCamButton, selectIsLocalVideoEnabled);
      } catch (error) {
        console.error("HMS Init Error:", error);
        statusEl.innerText = `Error: ${error.message}`;
      }
    }

    function onConnectionUpdate(isConnected) {
      if (isConnected) {
        statusContainer.style.opacity = "0";
        statusContainer.style.pointerEvents = "none";

        if (!callStartTime) {
          callStartTime = Date.now();
          startCallTimer();
        }
      } else {
        videoGrid.innerHTML = "";
        statusContainer.style.opacity = "1";
        statusContainer.style.pointerEvents = "auto";

        stopCallTimer();
        callTimerEl.textContent = "00:00";
      }
    }

    function startCallTimer() {
      callTimerInterval = setInterval(() => {
        const elapsedMs = Date.now() - callStartTime;
        const seconds = Math.floor(elapsedMs / 1000);
        const mins = String(Math.floor(seconds / 60)).padStart(2, "0");
        const secs = String(seconds % 60).padStart(2, "0");
        callTimerEl.textContent = `${mins}:${secs}`;
      }, 1000);
    }

    function stopCallTimer() {
      if (callTimerInterval) {
        clearInterval(callTimerInterval);
        callTimerInterval = null;
      }
      callStartTime = null;
    }

    function renderPeers(peers) {
      if (!Array.isArray(peers)) return;
      videoGrid.innerHTML = "";

      participantCountEl.innerText = peers.length;

      peers.forEach((peer) => {
        const tile = document.createElement("div");
        tile.className = "video-tile";
        if (peer.isLocal) tile.classList.add("local");

        const videoEl = document.createElement("video");
        videoEl.autoplay = true;
        videoEl.muted = peer.isLocal;
        videoEl.playsInline = true;

        const avatarEl = document.createElement("div");
        avatarEl.className = "avatar-placeholder";
        avatarEl.innerText = peer.name.charAt(0).toUpperCase();

        tile.appendChild(videoEl);
        tile.appendChild(avatarEl);

        if (peer.videoTrack) {
          if (peer.videoTrack.enabled) {
            hmsActions
              .attachVideo(peer.videoTrack.trackId, videoEl)
              .then(() => {
                avatarEl.style.display = "none";
                videoEl.style.display = "block";
              })
              .catch((e) =>
                console.error(`Attach video error for ${peer.name}`, e)
              );
          } else {
            avatarEl.style.display = "flex";
            videoEl.style.display = "none";
          }
        }

        const overlay = document.createElement("div");
        overlay.className = "tile-overlay";
        const name = document.createElement("span");
        name.innerText = peer.isLocal ? "You" : peer.name;
        overlay.appendChild(name);

        if (!peer.audioTrack || !peer.audioTrack.enabled) {
          const muteIcon = document.createElement("div");
          muteIcon.className = "mute-icon";
          muteIcon.innerHTML = `<i class="fa-solid fa-microphone-slash"></i>`;
          overlay.appendChild(muteIcon);
        }

        tile.appendChild(overlay);
        videoGrid.appendChild(tile);
      });
    }

    function updateMicButton(isEnabled) {
      const micBtn = document.getElementById("mic-btn");
      micBtn.classList.toggle("toggled-off", !isEnabled);
      micBtn.querySelector("i").className = isEnabled
        ? "fa-solid fa-microphone"
        : "fa-solid fa-microphone-slash";
    }

    function updateCamButton(isEnabled) {
      const camBtn = document.getElementById("cam-btn");
      camBtn.classList.toggle("toggled-off", !isEnabled);
      camBtn.querySelector("i").className = isEnabled
        ? "fa-solid fa-video"
        : "fa-solid fa-video-slash";
    }

    document.getElementById("mic-btn").addEventListener("click", async () => {
      const enabled = hmsStore.getState(selectIsLocalAudioEnabled) ?? false;
      await hmsActions.setLocalAudioEnabled(!enabled);
    });

    document.getElementById("cam-btn").addEventListener("click", async () => {
      const enabled = hmsStore.getState(selectIsLocalVideoEnabled) ?? false;
      await hmsActions.setLocalVideoEnabled(!enabled);
    });

    document
      .getElementById("end-call-btn")
      .addEventListener("click", async () => {
        await hmsActions.leave();
        stopCallTimer();
        statusEl.innerText = "You have left the room.";
      });

    window.onload = initHMS;
    window.onbeforeunload = () => {
      if (hmsActions) hmsActions.leave();
    };
  </script>
</body>
</html>
