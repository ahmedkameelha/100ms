<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>V2V Call</title>

  <!-- This script MUST come BEFORE your hms-bundle.js -->
  <script>
    window.process = { env: { NODE_ENV: 'production' } };
  </script>

  <!-- IMPORTANT: PASTE YOUR SCRIPT URL HERE -->
  <script src="https://cdn.jsdelivr.net/gh/ahmedkameelha/hmsweb@f09a25e53fb1f373631533a97e763cf1bde205e4/hms-bundle.js"></script>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <style>
    :root {
      --bg-color: #202124;
      --surface-color: #3c4043;
      --hover-color: #4a4b4f;
      --primary-text: #e8eaed;
      --secondary-text: #bdc1c6;
      --red-accent: #ea4335;
      --blue-accent: #8ab4f8;
      --font-family: 'Google Sans', sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      width: 100%; height: 100%;
      background: var(--bg-color);
      color: var(--primary-text);
      font-family: var(--font-family);
      overflow: hidden;
    }

    #container {
      width: 100%; height: 100%;
      display: flex; flex-direction: column;
    }

    /* Grid for peers */
    #peers-container {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      grid-auto-rows: minmax(180px, 1fr);
      gap: 12px;
      padding: 12px;
    }

    .video-tile {
      position: relative;
      background: #282a2d;
      border-radius: 10px;
      overflow: hidden;
      display: flex; align-items: center; justify-content: center;
    }
    .video-tile video {
      width: 100%; height: 100%;
      object-fit: cover;
    }

    .avatar-circle {
      width: 80px; height: 80px;
      border-radius: 50%;
      background: var(--surface-color);
      display: flex; align-items: center; justify-content: center;
      font-size: 32px; font-weight: 500;
      color: var(--primary-text);
    }

    .video-overlay {
      position: absolute;
      bottom: 8px; left: 8px;
      display: flex; align-items: center; gap: 8px;
      background: rgba(0,0,0,0.6);
      padding: 4px 10px; border-radius: 20px;
      font-size: 14px; font-weight: 500;
    }
    .mute-icon { color: var(--primary-text); }

    /* Control bar */
    #controls {
      position: absolute;
      bottom: 24px; left: 50%;
      transform: translateX(-50%);
      display: flex; gap: 12px;
      opacity: 0; visibility: hidden;
      transition: opacity 0.3s;
    }
    #container:hover #controls,
    #container.controls-visible #controls {
      opacity: 1; visibility: visible;
    }
    .btn-wrapper { position: relative; }
    .btn {
      background: var(--surface-color);
      border: none; width: 56px; height: 56px;
      border-radius: 50%; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .btn i { color: var(--primary-text); font-size: 22px; }
    .btn:hover { background: var(--hover-color); }
    .btn.toggled-off { background: var(--red-accent) !important; }
    .btn.toggled-off:hover { background: #d93025 !important; }
    #endBtn { background: var(--red-accent); }
    #endBtn:hover { background: #d93025; }

    .tooltip {
      position: absolute;
      bottom: 110%; left: 50%;
      transform: translateX(-50%);
      background: #4f5154;
      color: #fff; padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      opacity: 0; visibility: hidden;
      transition: opacity 0.2s;
    }
    .btn-wrapper:hover .tooltip {
      opacity: 1; visibility: visible;
    }

    #status {
      font-size: 20px;
      color: var(--secondary-text);
      text-align: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="status">Connecting...</div>
    <div id="peers-container"></div>

    <div id="controls">
      <div class="btn-wrapper">
        <button class="btn" id="micBtn"><i class="fa-solid fa-microphone"></i></button>
        <div class="tooltip" id="micTooltip">Mute</div>
      </div>
      <div class="btn-wrapper">
        <button class="btn" id="endBtn"><i class="fa-solid fa-phone"></i></button>
        <div class="tooltip">Leave call</div>
      </div>
      <div class="btn-wrapper">
        <button class="btn" id="camBtn"><i class="fa-solid fa-video"></i></button>
        <div class="tooltip" id="camTooltip">Turn off camera</div>
      </div>
    </div>
  </div>

  <script>
    let hmsManager, hmsStore, hmsActions;
    const { selectPeers, selectIsLocalAudioEnabled, selectIsLocalVideoEnabled, selectIsConnectedToRoom } = window.HMSReactiveStore;

    const statusEl = document.getElementById("status");
    const peersContainer = document.getElementById("peers-container");
    const containerEl = document.getElementById("container");

    function getParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        userName: params.get("userName") || "Guest",
        roomId: params.get("roomId")
      };
    }

    async function initHMS() {
      try {
        const { roomId, userName } = getParams();
        if (!roomId) throw new Error("Room ID missing!");

        hmsManager = new window.HMSReactiveStore();
        hmsManager.triggerOnSubscribe();
        hmsStore = hmsManager.getStore();
        hmsActions = hmsManager.getHMSActions();

        const authToken = await hmsActions.getAuthTokenByRoomCode({ roomCode: roomId });
        await hmsActions.join({ userName, authToken });

        hmsStore.subscribe(onConnectionUpdate, selectIsConnectedToRoom);
        hmsStore.subscribe(renderPeers, selectPeers);
        hmsStore.subscribe(updateMicButton, selectIsLocalAudioEnabled);
        hmsStore.subscribe(updateCamButton, selectIsLocalVideoEnabled);
      } catch (err) {
        console.error(err);
        statusEl.innerText = "Error: " + err.message;
      }
    }

    function onConnectionUpdate(isConnected) {
      if (isConnected) statusEl.style.display = "none";
    }

    function renderPeers(peers) {
      peersContainer.innerHTML = "";
      peers.forEach(peer => {
        const tile = document.createElement("div");
        tile.className = "video-tile";
        tile.id = `tile-${peer.id}`;

        const video = document.createElement("video");
        video.autoplay = true;
        video.playsInline = true;
        if (peer.isLocal) video.muted = true;

        if (peer.videoTrack && peer.videoTrack.stream) {
          video.srcObject = peer.videoTrack.stream;
        } else {
          const avatar = document.createElement("div");
          avatar.className = "avatar-circle";
          avatar.innerText = peer.name.charAt(0).toUpperCase();
          tile.appendChild(avatar);
        }

        const overlay = document.createElement("div");
        overlay.className = "video-overlay";
        overlay.innerHTML = `
          ${(peer.audioTrack && peer.audioTrack.enabled) ? "" : '<i class="fa-solid fa-microphone-slash mute-icon"></i>'}
          <span>${peer.isLocal ? "You" : peer.name}</span>
        `;

        tile.appendChild(video);
        tile.appendChild(overlay);
        peersContainer.appendChild(tile);
      });
    }

    function updateMicButton(isAudioEnabled) {
      const btn = document.getElementById("micBtn");
      const tip = document.getElementById("micTooltip");
      btn.classList.toggle("toggled-off", !isAudioEnabled);
      btn.querySelector("i").className = isAudioEnabled ? "fa-solid fa-microphone" : "fa-solid fa-microphone-slash";
      tip.innerText = isAudioEnabled ? "Mute" : "Unmute";
    }

    function updateCamButton(isVideoEnabled) {
      const btn = document.getElementById("camBtn");
      const tip = document.getElementById("camTooltip");
      btn.classList.toggle("toggled-off", !isVideoEnabled);
      btn.querySelector("i").className = isVideoEnabled ? "fa-solid fa-video" : "fa-solid fa-video-slash";
      tip.innerText = isVideoEnabled ? "Turn off camera" : "Turn on camera";
    }

    // Controls
    document.getElementById("micBtn").addEventListener("click", () => {
      const isEnabled = hmsStore.getState(window.HMSReactiveStore.selectIsLocalAudioEnabled);
      hmsActions.setLocalAudioEnabled(!isEnabled);
    });
    document.getElementById("camBtn").addEventListener("click", () => {
      const isEnabled = hmsStore.getState(window.HMSReactiveStore.selectIsLocalVideoEnabled);
      hmsActions.setLocalVideoEnabled(!isEnabled);
    });
    document.getElementById("endBtn").addEventListener("click", () => {
      hmsActions.leave();
      statusEl.innerText = "You have left the room.";
      statusEl.style.display = "block";
      peersContainer.innerHTML = "";
    });

    // Auto-hide controls
    let controlsTimeout;
    containerEl.addEventListener("mousemove", () => {
      containerEl.classList.add("controls-visible");
      clearTimeout(controlsTimeout);
      controlsTimeout = setTimeout(() => {
        containerEl.classList.remove("controls-visible");
      }, 3000);
    });

    window.onload = initHMS;
  </script>
</body>
</html>

